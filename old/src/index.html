<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel AI „Éó„É≠„É≥„Éó„ÉàÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, push, onValue, set, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.firebase = { database, auth, googleProvider, ref, push, onValue, set, remove, signInWithPopup, signOut, onAuthStateChanged };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
        }

        .header {
            background: linear-gradient(90deg, #4A90E2 0%, #7B68EE 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .unified-prompt-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .prompt-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .prompt-row:last-child {
            margin-bottom: 0;
        }

        .prompt-field {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex: 1;
        }

        .prompt-field h3 {
            min-width: 80px;
            margin: 0;
            padding-top: 8px;
            font-size: 0.9rem;
            color: #333;
        }

        .unified-prompt {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .unified-prompt.main-prompt {
            min-height: 120px;
        }

        .unified-prompt:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .title-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .title-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: border-color 0.3s;
        }

        .title-input:focus {
            outline: none;
            border-color: #4A90E2;
        }


        .input-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        textarea::placeholder {
            color: #f0f0f0;
            opacity: 0.3;
        }

        input::placeholder {
            color: #f0f0f0;
            opacity: 0.3;
        }

        .input-with-label {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-with-label h3 {
            margin: 0;
            min-width: 120px;
            padding-top: 8px;
            font-size: 0.9rem;
        }

        .input-with-label textarea {
            flex: 1;
        }

        .copy-btn-side {
            padding: 8px 12px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 40px;
            height: 40px;
            margin-top: 2px;
        }

        .copy-btn-side:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .save-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .save-and-clear-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .save-buttons {
            display: flex;
            gap: 15px;
            flex: 1;
        }

        .btn-save {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            flex: 1;
            max-width: 200px;
        }

        .btn-clear {
            padding: 12px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .btn-clear:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .title-input-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .title-input-row h3 {
            margin: 0;
            min-width: 140px;
            font-size: 1rem;
        }

        .title-input-row .title-input {
            flex: 1;
        }

        .potion-preview {
            background: #f8f9fa;
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
            min-height: 120px;
        }

        .potion-preview-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .potion-preview-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 3px solid #28a745;
            flex-shrink: 0;
        }

        .potion-preview-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 120px;
            justify-content: center;
        }

        .potion-preview-info span {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
            word-break: break-word;
        }

        .btn-remove-potion {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            align-self: flex-start;
            transition: all 0.3s;
        }

        .btn-remove-potion:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .debug-panel {
            background: white;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #17a2b8;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #17a2b8;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .debug-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .debug-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-copy-logs, .btn-clear-logs {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-copy-logs {
            background: #28a745;
            color: white;
        }

        .btn-copy-logs:hover {
            background: #218838;
        }

        .btn-clear-logs {
            background: #dc3545;
            color: white;
        }

        .btn-clear-logs:hover {
            background: #c82333;
        }

        .debug-logs {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: #f8f9fa;
            color: #333;
        }

        .debug-log-entry {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .debug-log-info {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .debug-log-success {
            background: #e8f5e8;
            border-left: 3px solid #4caf50;
        }

        .debug-log-error {
            background: #ffebee;
            border-left: 3px solid #f44336;
        }

        .debug-log-warn {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            min-width: 200px;
        }

        .search-input-group {
            display: flex;
            gap: 8px;
        }

        .search-input-group .search-input {
            flex: 1;
        }

        .btn-search {
            padding: 8px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 40px;
        }

        .btn-search:hover {
            background: #0056b3;
        }

        .btn-search-clear {
            padding: 8px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 40px;
        }

        .btn-search-clear:hover {
            background: #c82333;
        }

        .search-within-save {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .search-within-save h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .search-inline {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-input-group-compact {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input-compact {
            width: 200px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-compact {
            text-align: center;
            padding: 10px 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        .stats-compact span {
            font-weight: bold;
            color: #4A90E2;
        }

        .search-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 20px;
        }

        .search-keyword-tag {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: fadeInScale 0.3s ease;
        }

        .search-keyword-tag .remove-keyword {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            padding: 0 2px;
            margin-left: 2px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .search-keyword-tag .remove-keyword:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .exclude-keyword-tag {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: fadeInScale 0.3s ease;
        }

        .exclude-keyword-tag .remove-keyword {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            padding: 0 2px;
            margin-left: 2px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .exclude-keyword-tag .remove-keyword:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .tags-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tags-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .tag-input:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .add-tag-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .existing-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag-item {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #bbdefb;
        }

        .tag-item:hover {
            background: #1976d2;
            color: white;
        }

        .tag-item.selected {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }

        .current-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .current-tag {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .search-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .potion-input-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .potion-input-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4A90E2, #7B68EE);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .main-content {
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .stat-item {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4A90E2;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .prompt-list {
            display: grid;
            gap: 8px;
        }

        .prompt-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.2s;
        }

        .prompt-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .prompt-content-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt-image-main {
            flex-shrink: 0;
        }

        .prompt-main-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .prompt-info {
            flex: 1;
        }

        .prompt-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .prompt-thumbnail {
            display: flex;
            align-items: center;
        }

        .thumbnail-image {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #28a745;
            cursor: pointer;
            transition: all 0.3s;
        }

        .thumbnail-image:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .prompt-meta {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .mini-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 4px;
        }

        .mini-tag.potion-name {
            background: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }

        .prompt-title-line {
            font-size: 13px;
            color: #333;
            line-height: 1.3;
        }

        .btn-delete {
            padding: 6px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.05);
        }


        .prompt-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4A90E2;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 13px;
        }

        .character-content {
            border-left-color: #28a745;
        }


        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 80px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .prompt-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }


        @media (max-width: 768px) {
            .prompt-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .prompt-field h3 {
                min-width: auto;
                padding-top: 0;
            }
        }

        @media (max-width: 768px) {
            .search-filter-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .save-and-clear-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .save-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-save {
                max-width: none;
            }
            
            .btn-clear {
                align-self: stretch;
            }
            
            .title-input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .title-input-row h3 {
                min-width: auto;
                text-align: center;
            }
            
            .potion-preview-content {
                flex-direction: column;
                text-align: center;
            }
            
            .potion-preview-img {
                width: 100px;
                height: 100px;
            }
            
            .potion-preview-info {
                min-height: auto;
            }
            
            .prompt-main-image {
                width: 40px;
                height: 40px;
            }
            
            .thumbnail-image {
                width: 24px;
                height: 24px;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .version-badge {
                top: 10px;
                right: 15px;
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }

        /* Ë™çË®ºÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #333;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 15px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .google-login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .user-name {
            color: white;
            font-weight: 600;
            flex: 1;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* „Çø„ÉñÊ©üËÉΩ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .tab-container {
            display: flex;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:first-child {
            border-right: 1px solid rgba(255,255,255,0.5);
        }

        /* Novel AI „Çø„ÉñÔºàÁèæÂú®„ÅÆËâ≤Ôºâ */
        .tab-button[data-mode="novelai"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-button[data-mode="novelai"]:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Claude Code „Çø„ÉñÔºà„Ç™„É¨„É≥„Ç∏ÂØÑ„ÇäËå∂Ëâ≤Ôºâ */
        .tab-button[data-mode="claudecode"] {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
        }

        .tab-button[data-mode="claudecode"]:hover {
            background: linear-gradient(135deg, #7A3E0F 0%, #C0561A 100%);
        }

        /* „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ - Â§ßÂπÖÂº∑Ë™ø */
        .tab-button.active {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 3px solid #FFD700 !important; /* ÈáëËâ≤„ÅÆ„Éú„Éº„ÉÄ„Éº */
            position: relative;
            z-index: 10;
        }

        /* „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„Å´ËøΩÂä†„ÅÆË£ÖÈ£æ */
        .tab-button.active::before {
            content: '‚ú®';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #FFD700;
            color: #333;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ - „Çà„ÇäÊòéÁ¢∫„Å™ÈÅï„ÅÑ */
        .tab-button:not(.active) {
            opacity: 0.5;
            filter: grayscale(30%);
            transform: scale(0.95);
        }

        /* Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÅÆ„Éõ„Éê„ÉºÊôÇ */
        .tab-button:not(.active):hover {
            opacity: 0.8;
            filter: grayscale(0%);
            transform: scale(1.0);
        }
    </style>
</head>
<body>
    <!-- Ë™çË®º„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="authOverlay" class="auth-overlay" style="display: none;">
        <div class="auth-card">
            <h2 class="auth-title">üîê „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</h2>
            <p class="auth-subtitle">„Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´ÂÆâÂÖ®„Å´‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÄÅGoogle„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <button id="googleLoginBtn" class="google-login-btn">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google„Åß„É≠„Ç∞„Ç§„É≥
            </button>
        </div>
    </div>

    <div class="container">
        <div class="version-badge">v0.8-Firebase</div>
        <div class="header">
            <!-- „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë°®Á§∫ -->
            <div id="userInfo" class="user-info" style="display: none;">
                <img id="userAvatar" class="user-avatar" src="" alt="„É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº">
                <span id="userName" class="user-name"></span>
                <button id="logoutBtn" class="logout-btn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
            <h1>üé® Novel AI „Éó„É≠„É≥„Éó„ÉàÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
            <!-- „Çø„ÉñÊ©üËÉΩËøΩÂä† -->
            <div class="tab-container">
                <button class="tab-button active" data-mode="novelai" onclick="switchMode('novelai')">
                    üé® Novel AI
                </button>
                <button class="tab-button" data-mode="claudecode" onclick="switchMode('claudecode')">
                    üíª Claude Code
                </button>
            </div>
        </div>

        <div class="controls">
            <!-- „Çø„Ç§„Éà„É´ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div class="title-section">
                <div class="title-input-row">
                    <h3>üìù „Éó„É≠„É≥„Éó„Éà„Çø„Ç§„Éà„É´</h3>
                    <input type="text" id="promptTitle" class="title-input" placeholder="„Éó„É≠„É≥„Éó„Éà„Å´„Çø„Ç§„Éà„É´„Çí‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: Ê£Æ„ÅÆ‰∏≠„ÅÆÁæéÂ∞ëÂ•≥„ÄÅÊà¶Èóò„Ç∑„Éº„É≥„Å™„Å©Ôºâ" maxlength="50">
                </div>
            </div>

            <!-- „Éó„É≠„É≥„Éó„ÉàÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div class="input-section unified-prompt-section">
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>üåü „É°„Ç§„É≥</h3>
                        <textarea id="mainPrompt" class="unified-prompt main-prompt" placeholder="ËÉåÊôØ„ÄÅË®≠ÂÆö„ÄÅÂìÅË≥™ÊåáÂÆö„Å™„Å©..."></textarea>
                        <button onclick="copyIndividualPrompt('main')" class="copy-btn-side">üìã</button>
                    </div>
                </div>
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>üë§ 1‰∫∫ÁõÆ</h3>
                        <textarea id="character1" class="unified-prompt" placeholder="1‰∫∫ÁõÆ„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞..."></textarea>
                        <button onclick="copyIndividualPrompt('char1')" class="copy-btn-side">üìã</button>
                    </div>
                </div>
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>üë• 2‰∫∫ÁõÆ</h3>
                        <textarea id="character2" class="unified-prompt" placeholder="2‰∫∫ÁõÆ„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞..."></textarea>
                        <button onclick="copyIndividualPrompt('char2')" class="copy-btn-side">üìã</button>
                    </div>
                </div>
                <div class="prompt-row">
                    <div class="prompt-field">
                        <h3>üë•+ 3„Äú6‰∫∫ÁõÆ</h3>
                        <textarea id="character3to6" class="unified-prompt" placeholder="3„Äú6‰∫∫ÁõÆ„ÅÆËøΩÂä†„Ç≠„É£„É©„ÇØ„Çø„Éº..."></textarea>
                        <button onclick="copyIndividualPrompt('char3to6')" class="copy-btn-side">üìã</button>
                    </div>
                </div>
            </div>

            <!-- „Éó„É≠„É≥„Éó„Éà‰øùÂ≠ò„ÉªÊ§úÁ¥¢„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="save-section">
                <div class="save-and-clear-section">
                    <div class="save-buttons">
                        <button onclick="debugLog('üî• STEP1: ‰øùÂ≠ò„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü!', 'info'); savePrompt('new')" class="btn-primary btn-save">üíæ Êñ∞Ë¶è‰øùÂ≠ò</button>
                        <button onclick="savePrompt('overwrite')" class="btn-secondary btn-save" id="overwriteBtn" style="display: none;">üìù ‰∏äÊõ∏„Åç‰øùÂ≠ò</button>
                    </div>
                    <button onclick="clearAllInputs()" class="btn-clear">üßπ „ÇØ„É™„Ç¢</button>
                    <button onclick="resetLocalStorage()" class="btn-clear" style="background: red; color: white;">üö® ÂÆåÂÖ®„É™„Çª„ÉÉ„Éà</button>
                </div>
                
                <!-- „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ -->
                <div class="search-within-save">
                    <div class="search-inline">
                        <h4>Ê§úÁ¥¢</h4>
                        <div class="search-input-group-compact">
                            <input type="text" id="searchInput" class="search-input-compact" placeholder="„Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ„ÅßÊ§úÁ¥¢...">
                            <button onclick="addSearchKeyword()" class="btn-search">‚ûï</button>
                            <button onclick="clearAllSearchKeywords()" class="btn-search-clear">‚ùå</button>
                        </div>
                    </div>
                    <div class="search-keywords" id="searchKeywords">
                        <!-- Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Çø„Ç∞„ÅåË°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    
                    <div class="search-inline" style="margin-top: 10px;">
                        <h4>Èô§Â§ñ</h4>
                        <div class="search-input-group-compact">
                            <input type="text" id="excludeInput" class="search-input-compact" placeholder="Èô§Â§ñ„Åô„Çã„Ç≠„Éº„ÉØ„Éº„Éâ...">
                            <button onclick="addExcludeKeyword()" class="btn-search">‚ûñ</button>
                            <button onclick="clearAllExcludeKeywords()" class="btn-search-clear">‚ùå</button>
                        </div>
                    </div>
                    
                    <div class="search-keywords" id="excludeKeywords">
                        <!-- Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„Çø„Ç∞„ÅåË°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
                
                <div id="potionPreview" class="potion-preview" style="display: none;">
                    <div class="potion-preview-content">
                        <img id="potionPreviewImage" src="" alt="„Éù„Éº„Ç∑„Éß„É≥ÁîªÂÉè" class="potion-preview-img">
                        <div class="potion-preview-info">
                            <span id="potionPreviewName">„Éù„Éº„Ç∑„Éß„É≥Âêç</span>
                            <button onclick="removePotionData()" class="btn-remove-potion">üóëÔ∏è ÂâäÈô§</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="main-content">
                <!-- Áµ±Ë®àË°®Á§∫ -->
                <div class="stats-compact">
                    Á∑è„Éó„É≠„É≥„Éó„Éà <span id="totalCount">0</span> | Ê§úÁ¥¢ÁµêÊûú <span id="searchCount">0</span> | ‰ªäÊó•ËøΩÂä† <span id="todayCount">0</span> | „Çø„Ç∞Êï∞ <span id="tagCount">0</span>
                </div>

                <!-- „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß -->
                <div id="promptList" class="prompt-list">
                    <div class="empty-state">
                        <h3>üìù „Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
                        <p>ÊúÄÂàù„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>
            </div>

            <!-- „Çø„Ç∞ÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="tags-section">
                <div class="input-with-label">
                    <h3>üè∑Ô∏è „Çø„Ç∞ÁÆ°ÁêÜ</h3>
                    <input type="text" id="tagInput" class="tag-input" placeholder="Êñ∞„Åó„ÅÑ„Çø„Ç∞„ÇíÂÖ•Âäõ... (‰æã: Áî∑ÊÄß, Â•≥ÊÄß, Ê£Æ„ÅÆ‰∏≠, Â§ú)">
                    <button onclick="addTag()" class="add-tag-btn">‚ûï „Çø„Ç∞ËøΩÂä†</button>
                </div>
                
                <div class="existing-tags" id="existingTags">
                    <!-- Êó¢Â≠ò„Çø„Ç∞„ÅåÂãïÁöÑ„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
                
                <div class="current-tags" id="currentTags">
                    <!-- ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Çø„Ç∞„ÅåË°®Á§∫„Åï„Çå„Çã -->
                </div>
            </div>

            <!-- „Éù„Éº„Ç∑„Éß„É≥Ë™≠„ÅøËæº„Åø„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="potion-input-section">
                <h4>üß™ „Éù„Éº„Ç∑„Éß„É≥</h4>
                <input type="file" id="potionInput" class="file-input" accept=".txt,.json,.png,.jpg,.jpeg" multiple onchange="loadPotions()">
            </div>

            <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
            <div class="button-group">
                <button onclick="exportData()" class="btn-info">üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                <button onclick="importData()" class="btn-info">üì• „Ç§„É≥„Éù„Éº„Éà</button>
                <button onclick="clearAll()" class="btn-secondary">üóëÔ∏è ÂÖ®ÂâäÈô§</button>
                <button onclick="toggleDebugPanel()" class="btn-info">üîç „Éá„Éê„ÉÉ„Ç∞</button>
                <button onclick="debugLog('„ÉÜ„Çπ„Éà„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ: currentEditingId=' + currentEditingId + ', prompts.length=' + prompts.length, 'info')" class="btn-info">üß™ „ÉÜ„Çπ„Éà</button>
            </div>

            <!-- „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ -->
            <div id="debugPanel" class="debug-panel" style="display: none;">
                <div class="debug-header">
                    <h4>üîç „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</h4>
                    <div class="debug-buttons">
                        <button onclick="copyDebugLogs()" class="btn-copy-logs">üìã „Ç≥„Éî„Éº</button>
                        <button onclick="clearDebugLogs()" class="btn-clear-logs">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                    </div>
                </div>
                <div id="debugLogs" class="debug-logs"></div>
            </div>
        </div>
    </div>

    <script>
        let prompts = [];
        let allTags = new Set();
        let currentTags = new Set();
        let currentSearch = '';
        let searchKeywords = new Set(); // Ë§áÊï∞Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ
        let excludeKeywords = new Set(); // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ
        let currentEditingId = null; // ÁèæÂú®Á∑®ÈõÜ‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„ÉàID
        let debugLogs = []; // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞‰øùÂ≠òÁî®
        let currentMode = 'novelai'; // ÁèæÂú®„ÅÆ„É¢„Éº„Éâ (novelai/claudecode)
        
        // FirebaseÈñ¢ÈÄ£Â§âÊï∞
        let currentUser = null;
        let firebaseReady = false;

        // FirebaseË™çË®ºÈñ¢Êï∞
        async function initializeAuth() {
            try {
                const { auth, onAuthStateChanged, signInWithPopup, signOut, googleProvider } = window.firebase;
                
                // Ë™çË®ºÁä∂ÊÖãÁõ£Ë¶ñ
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        showUserInfo(user);
                        hideAuthOverlay();
                        loadUserData();
                    } else {
                        showAuthOverlay();
                        hideUserInfo();
                    }
                });
                
                // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                document.getElementById('googleLoginBtn').addEventListener('click', async () => {
                    try {
                        await signInWithPopup(auth, googleProvider);
                    } catch (error) {
                        console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                        alert('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                });
                
                // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                    }
                });
                
                firebaseReady = true;
                debugLog('FirebaseË™çË®ºÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
                
            } catch (error) {
                console.error('FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                debugLog('FirebaseÂàùÊúüÂåñ„Ç®„É©„Éº: ' + error.message, 'error');
                // Firebase„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØlocalStorage„É¢„Éº„Éâ„ÅßÂãï‰Ωú
                firebaseReady = false;
                hideAuthOverlay();
                loadPrompts(); // localStorage „Åã„ÇâË™≠„ÅøËæº„Åø
            }
        }
        
        function showAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'flex';
        }
        
        function hideAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'none';
        }
        
        function showUserInfo(user) {
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            userAvatar.src = user.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjdlZWEiLz4KPHR0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtc2l6ZT0iMTRweCIgZm9udC13ZWlnaHQ9ImJvbGQiPkEKPC90ZXh0Pgo8L3N2Zz4K';
            userName.textContent = user.displayName || user.email;
            userInfo.style.display = 'flex';
        }
        
        function hideUserInfo() {
            document.getElementById('userInfo').style.display = 'none';
        }

        // Firebase Realtime DatabaseÊìç‰ΩúÈñ¢Êï∞
        async function loadUserData() {
            if (!firebaseReady || !currentUser) {
                debugLog('FirebaseÊú™Ê∫ñÂÇô„Åæ„Åü„ÅØ„É¶„Éº„Ç∂„ÉºÊú™„É≠„Ç∞„Ç§„É≥ - localStorage‰ΩøÁî®', 'warning');
                loadPrompts();
                return;
            }
            
            try {
                const { database, ref, onValue } = window.firebase;
                const userRef = ref(database, `users/${currentUser.uid}/prompts`);
                
                debugLog('=== FirebaseË™≠„ÅøËæº„ÅøÈñãÂßã ===', 'info');
                debugLog(`„É¶„Éº„Ç∂„ÉºID: ${currentUser.uid}`, 'info');
                
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        prompts = Object.values(data);
                        // „Çø„Ç∞„ÇÇÂæ©ÂÖÉ
                        allTags = new Set();
                        prompts.forEach(prompt => {
                            if (prompt.tags) {
                                prompt.tags.forEach(tag => allTags.add(tag));
                            }
                            // Êó•ÊôÇÂæ©ÂÖÉ
                            if (typeof prompt.timestamp === 'string') {
                                prompt.timestamp = new Date(prompt.timestamp);
                            }
                        });
                        debugLog(`üî• FirebaseË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${prompts.length}‰ª∂`, 'success');
                    } else {
                        prompts = [];
                        allTags = new Set();
                        debugLog('Firebase: „Éá„Éº„Çø„Å™„ÅóÔºàÊñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÔºâ', 'info');
                    }
                    
                    displayPrompts();
                    updateStats();
                    updateTagsDisplay();
                }, (error) => {
                    console.error('FirebaseË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    debugLog('FirebaseË™≠„ÅøËæº„Åø„Ç®„É©„Éº - localStorage‰ΩøÁî®', 'error');
                    loadPrompts(); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                });
                
            } catch (error) {
                console.error('FirebaseÊìç‰Ωú„Ç®„É©„Éº:', error);
                debugLog('FirebaseÊìç‰Ωú„Ç®„É©„Éº - localStorage‰ΩøÁî®', 'error');
                loadPrompts();
            }
        }
        
        async function saveUserData() {
            if (!firebaseReady || !currentUser) {
                debugLog('FirebaseÊú™Ê∫ñÂÇô - localStorage‰øùÂ≠ò', 'warning');
                savePrompts();
                return;
            }
            
            try {
                const { database, ref, set } = window.firebase;
                const userRef = ref(database, `users/${currentUser.uid}/prompts`);
                
                // „Éó„É≠„É≥„Éó„Éà„Çí„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂΩ¢Âºè„Åß‰øùÂ≠òÔºà„Ç≠„Éº„ÅØ„Éó„É≠„É≥„Éó„ÉàIDÔºâ
                const promptsObject = {};
                prompts.forEach(prompt => {
                    promptsObject[prompt.id] = prompt;
                });
                
                await set(userRef, promptsObject);
                debugLog(`üî• Firebase‰øùÂ≠òÂÆå‰∫Ü: ${prompts.length}‰ª∂`, 'success');
                
                // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å®„Åó„Å¶localStorage„Å´„ÇÇ‰øùÂ≠ò
                savePrompts();
                
            } catch (error) {
                console.error('Firebase‰øùÂ≠ò„Ç®„É©„Éº:', error);
                debugLog('Firebase‰øùÂ≠ò„Ç®„É©„Éº - localStorage‰øùÂ≠ò', 'error');
                savePrompts(); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.onload = function() {
            // FirebaseÂàùÊúüÂåñ„ÇíÊúÄÂÑ™ÂÖà„ÅßÂÆüË°å
            setTimeout(initializeAuth, 100); // Firebase SDK„ÅÆË™≠„ÅøËæº„ÅøÂæÖ„Å°
            
            // UIÂàùÊúüÂåñ
            updateTagsDisplay();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTag();
                }
            });
            
            // Ê§úÁ¥¢„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSearchKeyword();
                }
            });
            
            // Èô§Â§ñÂÖ•Âäõ„ÅÆEnter„Ç≠„ÉºÂØæÂøú
            document.getElementById('excludeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addExcludeKeyword();
                }
            });
        };

        // Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„ÉâËøΩÂä†
        function addSearchKeyword() {
            const input = document.getElementById('searchInput');
            const keyword = input.value.trim();
            
            if (!keyword) return;
            
            searchKeywords.add(keyword);
            input.value = '';
            updateSearchKeywordsDisplay();
            displayPrompts();
            showNotification(`Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Äå${keyword}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
        }

        // Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„ÉâÂâäÈô§
        function removeSearchKeyword(keyword) {
            searchKeywords.delete(keyword);
            updateSearchKeywordsDisplay();
            displayPrompts();
            showNotification(`Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Äå${keyword}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
        }

        // ÂÖ®Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇØ„É™„Ç¢
        function clearAllSearchKeywords() {
            searchKeywords.clear();
            document.getElementById('searchInput').value = '';
            updateSearchKeywordsDisplay();
            displayPrompts();
            showNotification('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ®„Å¶„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        }

        // Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„ÉâË°®Á§∫Êõ¥Êñ∞
        function updateSearchKeywordsDisplay() {
            const container = document.getElementById('searchKeywords');
            container.innerHTML = Array.from(searchKeywords).map(keyword => 
                `<span class="search-keyword-tag">
                    ${keyword}
                    <span class="remove-keyword" onclick="removeSearchKeyword('${keyword}')">√ó</span>
                </span>`
            ).join('');
        }

        // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„ÉâËøΩÂä†
        function addExcludeKeyword() {
            const input = document.getElementById('excludeInput');
            const keyword = input.value.trim();
            
            if (!keyword) return;
            
            excludeKeywords.add(keyword);
            input.value = '';
            updateExcludeKeywordsDisplay();
            displayPrompts();
            showNotification(`Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„Äå${keyword}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
        }

        // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„ÉâÂâäÈô§
        function removeExcludeKeyword(keyword) {
            excludeKeywords.delete(keyword);
            updateExcludeKeywordsDisplay();
            displayPrompts();
            showNotification(`Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„Äå${keyword}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
        }

        // ÂÖ®Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇØ„É™„Ç¢
        function clearAllExcludeKeywords() {
            excludeKeywords.clear();
            document.getElementById('excludeInput').value = '';
            updateExcludeKeywordsDisplay();
            displayPrompts();
            showNotification('Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ®„Å¶„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        }

        // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„ÉâË°®Á§∫Êõ¥Êñ∞
        function updateExcludeKeywordsDisplay() {
            const container = document.getElementById('excludeKeywords');
            container.innerHTML = Array.from(excludeKeywords).map(keyword => 
                `<span class="exclude-keyword-tag">
                    ${keyword}
                    <span class="remove-keyword" onclick="removeExcludeKeyword('${keyword}')">√ó</span>
                </span>`
            ).join('');
        }

        // ÂÄãÂà•„Éó„É≠„É≥„Éó„Éà„ÅÆ„Ç≥„Éî„Éº
        async function copyIndividualPrompt(type) {
            let content = '';
            
            switch(type) {
                case 'main':
                    content = document.getElementById('mainPrompt').value.trim();
                    break;
                case 'char1':
                    content = document.getElementById('character1').value.trim();
                    break;
                case 'char2':
                    content = document.getElementById('character2').value.trim();
                    break;
                case 'char3to6':
                    content = document.getElementById('character3to6').value.trim();
                    break;
            }
            
            if (!content) {
                alert('„Ç≥„Éî„Éº„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(content);
                showNotification(`${getPromptTypeName(type)}„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ`);
            } catch (err) {
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function getPromptTypeName(type) {
            const names = {
                'main': '„É°„Ç§„É≥„Éó„É≠„É≥„Éó„Éà',
                'char1': '1‰∫∫ÁõÆ„Ç≠„É£„É©„ÇØ„Çø„Éº',
                'char2': '2‰∫∫ÁõÆ„Ç≠„É£„É©„ÇØ„Çø„Éº',
                'char3to6': '3„Äú6‰∫∫ÁõÆ„Ç≠„É£„É©„ÇØ„Çø„Éº'
            };
            return names[type] || type;
        }

        // „Çø„Ç∞„ÅÆËøΩÂä†
        function addTag() {
            const input = document.getElementById('tagInput');
            const tagName = input.value.trim();
            
            if (!tagName) return;
            
            currentTags.add(tagName);
            allTags.add(tagName);
            
            input.value = '';
            updateTagsDisplay();
        }

        // „Çø„Ç∞Ë°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateTagsDisplay() {
            // Êó¢Â≠ò„Çø„Ç∞‰∏ÄË¶ß„ÅÆÊõ¥Êñ∞
            const existingTagsContainer = document.getElementById('existingTags');
            existingTagsContainer.innerHTML = Array.from(allTags).map(tag => 
                `<span class="tag-item ${currentTags.has(tag) ? 'selected' : ''}" onclick="toggleTag('${tag}')">${tag}</span>`
            ).join('');
            
            // ÁèæÂú®ÈÅ∏Êäû‰∏≠„Çø„Ç∞„ÅÆÊõ¥Êñ∞
            const currentTagsContainer = document.getElementById('currentTags');
            currentTagsContainer.innerHTML = Array.from(currentTags).map(tag => 
                `<span class="current-tag">${tag} <span class="remove-tag" onclick="removeCurrentTag('${tag}')">√ó</span></span>`
            ).join('');
            
        }

        // „Çø„Ç∞„ÅÆÂàá„ÇäÊõø„Åà
        function toggleTag(tagName) {
            if (currentTags.has(tagName)) {
                currentTags.delete(tagName);
            } else {
                currentTags.add(tagName);
            }
            updateTagsDisplay();
        }

        // ÁèæÂú®„ÅÆ„Çø„Ç∞„ÇíÂâäÈô§
        function removeCurrentTag(tagName) {
            currentTags.delete(tagName);
            updateTagsDisplay();
        }

        // „Éó„É≠„É≥„Éó„Éà„ÅÆ‰øùÂ≠ò
        function savePrompt(mode = 'new') {
            debugLog(`=== „Éó„É≠„É≥„Éó„Éà‰øùÂ≠òÈñãÂßã ===`, 'info');
            debugLog(`‰øùÂ≠ò„É¢„Éº„Éâ: ${mode}`, 'info');
            
            const title = document.getElementById('promptTitle').value.trim();
            const mainPrompt = document.getElementById('mainPrompt').value.trim();
            
            debugLog(`üî• STEP3: „Çø„Ç§„Éà„É´ÂèñÂæó: "${title}" (Èï∑„Åï: ${title.length})`, 'info');
            debugLog(`üî• STEP3: „É°„Ç§„É≥„Éó„É≠„É≥„Éó„ÉàÂèñÂæó: "${mainPrompt}" (Èï∑„Åï: ${mainPrompt.length})`, 'info');
            debugLog(`üî• STEP3: mainPrompt„Éï„Ç£„Éº„É´„ÉâÂ≠òÂú®Á¢∫Ë™ç: ${document.getElementById('mainPrompt') ? '„ÅÇ„Çä' : '„Å™„Åó'}`, 'info');
            
            if (!title) {
                debugLog('„Çø„Ç§„Éà„É´„ÅåÁ©∫„ÅÆ„Åü„ÇÅ‰øùÂ≠ò‰∏≠Ê≠¢', 'error');
                alert('„Éó„É≠„É≥„Éó„Éà„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!mainPrompt) {
                debugLog('„É°„Ç§„É≥„Éó„É≠„É≥„Éó„Éà„ÅåÁ©∫„ÅÆ„Åü„ÇÅ‰øùÂ≠ò‰∏≠Ê≠¢', 'error');
                alert('„É°„Ç§„É≥„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const promptData = {
                title: title,
                mainPrompt: mainPrompt,
                character1: document.getElementById('character1').value.trim(),
                character2: document.getElementById('character2').value.trim(),
                character3to6: document.getElementById('character3to6').value.trim(),
                tags: Array.from(currentTags),
                timestamp: new Date(),
                source: window.currentPotionData ? 'potion' : 'manual'
            };
            
            debugLog(`üî• promptData‰ΩúÊàêÂæå:`, 'info');
            debugLog(`  - title: "${promptData.title}"`, 'info');
            debugLog(`  - mainPrompt: "${promptData.mainPrompt}"`, 'info');
            debugLog(`  - character1: "${promptData.character1}"`, 'info');

            // „Éù„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøΩÂä†
            if (window.currentPotionData) {
                promptData.image = window.currentPotionData.image;
                promptData.imageName = window.currentPotionData.imageName;
                promptData.potionName = window.currentPotionData.potionName;
                // „Éù„Éº„Ç∑„Éß„É≥„Çø„Ç∞„ÇíËøΩÂä†
                if (!promptData.tags.includes('„Éù„Éº„Ç∑„Éß„É≥')) {
                    promptData.tags.push('„Éù„Éº„Ç∑„Éß„É≥');
                    currentTags.add('„Éù„Éº„Ç∑„Éß„É≥');
                }
            }

            debugLog(`‰øùÂ≠òÂá¶ÁêÜÈñãÂßã: mode=${mode}, currentEditingId=${currentEditingId}`, 'info');
            
            if (mode === 'overwrite' && currentEditingId) {
                // ‰∏äÊõ∏„Åç‰øùÂ≠ò
                debugLog('‰∏äÊõ∏„Åç‰øùÂ≠òÂá¶ÁêÜÈñãÂßã', 'info');
                const index = prompts.findIndex(p => p.id == currentEditingId);
                debugLog(`ÂØæË±°„Éó„É≠„É≥„Éó„Éà„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ: ${index}`, 'info');
                
                if (index !== -1) {
                    const oldPrompt = prompts[index];
                    debugLog(`‰∏äÊõ∏„ÅçÂØæË±°: "${oldPrompt.title}"`, 'info');
                    
                    promptData.id = currentEditingId;
                    promptData.originalTimestamp = prompts[index].timestamp; // ÂÖÉ„ÅÆ‰ΩúÊàêÊó•ÊôÇ„Çí‰øùÊåÅ
                    prompts[index] = promptData;
                    
                    debugLog('‰∏äÊõ∏„Åç‰øùÂ≠òÂÆå‰∫Ü', 'success');
                    showNotification('„Éó„É≠„É≥„Éó„Éà„Çí‰∏äÊõ∏„Åç‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                } else {
                    // ÂÖÉ„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰øùÂ≠ò
                    debugLog(`‚ùå ‰∏äÊõ∏„ÅçÂØæË±°„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÔºàID: ${currentEditingId}Ôºâ„ÄÅÊñ∞Ë¶è‰øùÂ≠ò„Å´Â§âÊõ¥`, 'warn');
                    promptData.id = Date.now();
                    prompts.unshift(promptData);
                    showNotification('„Éó„É≠„É≥„Éó„Éà„ÇíÊñ∞Ë¶è‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                }
            } else {
                // Êñ∞Ë¶è‰øùÂ≠ò
                debugLog('Êñ∞Ë¶è‰øùÂ≠òÂá¶ÁêÜÂÆüË°å', 'info');
                promptData.id = Date.now();
                prompts.unshift(promptData);
                
                debugLog(`üî• ÈÖçÂàóËøΩÂä†Âæå„ÅÆÊúÄÊñ∞„Éó„É≠„É≥„Éó„Éà:`, 'info');
                debugLog(`  - id: ${prompts[0].id}`, 'info');
                debugLog(`  - title: "${prompts[0].title}"`, 'info');
                debugLog(`  - mainPrompt: "${prompts[0].mainPrompt}"`, 'info');
                
                showNotification('„Éó„É≠„É≥„Éó„Éà„ÇíÊñ∞Ë¶è‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            }
            
            // „Çø„Ç∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çª„ÉÉ„Éà„Å´ËøΩÂä†
            currentTags.forEach(tag => allTags.add(tag));
            debugLog(`„Çø„Ç∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çª„ÉÉ„Éà„Å´ËøΩÂä†: [${Array.from(currentTags).join(', ')}]`, 'info');
            
            debugLog('savePrompts()Âëº„Å≥Âá∫„ÅóÂâç„ÅÆ„Éó„É≠„É≥„Éó„ÉàÊï∞: ' + prompts.length, 'info');
            
            // Firebase„ÅåÂà©Áî®ÂèØËÉΩ„Å™„ÇâFirebase„Å´‰øùÂ≠ò„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞localStorage
            if (firebaseReady && currentUser) {
                saveUserData();
            } else {
                savePrompts();
            }
            
            debugLog('‰øùÂ≠òÂá¶ÁêÜÂëº„Å≥Âá∫„ÅóÂæå„ÅÆ„Éó„É≠„É≥„Éó„ÉàÊï∞: ' + prompts.length, 'info');
            
            clearInputs();
            displayPrompts();
            updateStats();
            updateTagsDisplay();
            updateSaveButtons();
            
            debugLog('=== „Éó„É≠„É≥„Éó„Éà‰øùÂ≠òÂÆå‰∫Ü ===', 'success');
        }

        // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÇØ„É™„Ç¢
        function clearInputs() {
            document.getElementById('promptTitle').value = '';
            document.getElementById('mainPrompt').value = '';
            document.getElementById('character1').value = '';
            document.getElementById('character2').value = '';
            document.getElementById('character3to6').value = '';
            currentTags.clear();
            // „Éù„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇÇ„ÇØ„É™„Ç¢
            window.currentPotionData = null;
            currentEditingId = null;
            updatePotionPreview();
            updateSaveButtons();
        }

        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„Çâ‰øùÂ≠ò
        async function saveFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text.trim()) {
                    alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅåÁ©∫„Åß„Åô');
                    return;
                }

                const prompt = {
                    id: Date.now(),
                    title: text.trim().substring(0, 30) + (text.length > 30 ? '...' : ''),
                    mainPrompt: text.trim(),
                    character1: '',
                    character2: '',
                    character3to6: '',
                    tags: Array.from(currentTags),
                    timestamp: new Date(),
                    source: 'clipboard'
                };

                prompts.unshift(prompt);
                
                currentTags.forEach(tag => allTags.add(tag));
                
                savePrompts();
                displayPrompts();
                updateStats();
                
                showNotification('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„Çâ„Éó„É≠„É≥„Éó„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (err) {
                alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆË™≠„ÅøÂèñ„Çä„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // „Éó„É≠„É≥„Éó„Éà„ÅÆË°®Á§∫
        function displayPrompts() {
            debugLog(`=== displayPromptsÈñãÂßã ===`, 'info');
            debugLog(`promptsÈÖçÂàó„ÅÆ‰ª∂Êï∞: ${prompts.length}`, 'info');
            debugLog(`promptsÈÖçÂàó„ÅÆÂÜÖÂÆπ: ${JSON.stringify(prompts.map(p => ({id: p.id, title: p.title}))).substring(0, 200)}`, 'info');
            
            const container = document.getElementById('promptList');
            const filteredPrompts = filterPrompts();
            
            debugLog(`„Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆ‰ª∂Êï∞: ${filteredPrompts.length}`, 'info');

            if (filteredPrompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üîç ${currentSearch ? 'Ê§úÁ¥¢ÁµêÊûú„Å™„Åó' : '„Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}</h3>
                        <p>${currentSearch ? 'Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„Çã„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' : 'ÊúÄÂàù„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ'}</p>
                    </div>
                `;
                updateStats();
                return;
            }

            debugLog(`HTML„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÈñãÂßã: ${filteredPrompts.length}‰ª∂`, 'info');
            
            // ÁîªÂÉè„Éá„Éº„Çø„ÅÆ„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
            let totalImageSize = 0;
            filteredPrompts.forEach((prompt, index) => {
                if (prompt.image) {
                    const imageSize = prompt.image.length;
                    totalImageSize += imageSize;
                    debugLog(`„Éó„É≠„É≥„Éó„Éà${index + 1}„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫: ${Math.round(imageSize / 1024)}KB`, 'info');
                }
            });
            debugLog(`Á∑èÁîªÂÉè„Éá„Éº„Çø„Çµ„Ç§„Ç∫: ${Math.round(totalImageSize / 1024)}KB`, 'info');
            
            try {
                const htmlContent = filteredPrompts.map(prompt => `
                    <div class="prompt-item">
                        <div class="prompt-content-row">
                            <div class="prompt-info" onclick="restorePromptToInputs(&quot;${prompt.id}&quot;)" style="cursor: pointer;">
                                <div class="prompt-meta">
                                    üìÖ ${formatDateTime(prompt.timestamp)} 
                                    ${prompt.source === 'clipboard' ? 'üìã' : prompt.source === 'file' ? 'üìÅ' : prompt.source === 'potion' ? 'üß™' : '‚úèÔ∏è'}
                                    ${prompt.tags.map(tag => `<span class="mini-tag">${tag}</span>`).join('')}
                                    ${prompt.potionName ? `<span class="mini-tag potion-name">üß™ ${prompt.potionName}</span>` : ''}
                                </div>
                                <div class="prompt-title-line">
                                    <strong>${highlightSearchKeywords(prompt.title || 'ÁÑ°È°å')}</strong> - ${highlightSearchKeywords(truncateText(prompt.mainPrompt, 50))}
                                </div>
                            </div>
                            <div class="prompt-actions">
                                ${prompt.image ? `<button onclick="showImagePopup(&quot;${prompt.id}&quot;)" class="btn-image" title="ÁîªÂÉè„ÇíË°®Á§∫">üñºÔ∏è</button>` : ''}
                                <button onclick="deletePrompt(&quot;${prompt.id}&quot;)" class="btn-delete">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                debugLog(`HTMLÊñáÂ≠óÂàóÈï∑: ${htmlContent.length}ÊñáÂ≠ó`, 'info');
                container.innerHTML = htmlContent;
                debugLog(`DOMÊõ¥Êñ∞ÂÆå‰∫Ü`, 'success');
                
            } catch (error) {
                debugLog(`HTML„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Ç®„É©„Éº: ${error.message}`, 'error');
                debugLog(`„Ç®„É©„ÉºË©≥Á¥∞: ${error.stack}`, 'error');
            }

            updateStats();
        }

        // ÁîªÂÉè„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showImagePopup(promptId) {
            const prompt = prompts.find(p => p.id == promptId);
            if (!prompt || !prompt.image) return;
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = prompt.image;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            popup.appendChild(img);
            popup.onclick = () => popup.remove();
            document.body.appendChild(popup);
        }

        // ‰øùÂ≠òÊ∏à„Åø„Éó„É≠„É≥„Éó„Éà„ÅÆ„Ç≥„Éî„Éº
        async function copyStoredPrompt(id, type) {
            const prompt = prompts.find(p => p.id == id);
            if (!prompt) return;

            let content = '';
            switch(type) {
                case 'main':
                    content = prompt.mainPrompt;
                    break;
                case 'char1':
                    content = prompt.character1;
                    break;
                case 'char2':
                    content = prompt.character2;
                    break;
                case 'char3to6':
                    content = prompt.character3to6;
                    break;
            }

            if (!content.trim()) {
                alert('„Ç≥„Éî„Éº„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                await navigator.clipboard.writeText(content);
                showNotification(`${getPromptTypeName(type)}„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ`);
            } catch (err) {
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // „Éó„É≠„É≥„Éó„Éà„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterPrompts() {
            let filtered = prompts;

            // Ë§áÊï∞„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ÔºàANDÊ§úÁ¥¢Ôºâ
            if (searchKeywords.size > 0) {
                const keywords = Array.from(searchKeywords).map(k => k.toLowerCase());
                debugLog(`Ë§áÊï∞„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ÂÆüË°å: [${keywords.join(', ')}] - ÂØæË±°‰ª∂Êï∞: ${prompts.length}`, 'info');
                
                filtered = filtered.filter(prompt => {
                    // ÂÖ®„Å¶„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Åå„Éû„ÉÉ„ÉÅ„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàANDÊ§úÁ¥¢Ôºâ
                    return keywords.every(searchTerm => {
                        const titleMatch = prompt.title && prompt.title.toLowerCase().includes(searchTerm);
                        const mainMatch = prompt.mainPrompt && prompt.mainPrompt.toLowerCase().includes(searchTerm);
                        const char1Match = prompt.character1 && prompt.character1.toLowerCase().includes(searchTerm);
                        const char2Match = prompt.character2 && prompt.character2.toLowerCase().includes(searchTerm);
                        const char3Match = prompt.character3to6 && prompt.character3to6.toLowerCase().includes(searchTerm);
                        const tagMatch = prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        
                        return titleMatch || mainMatch || char1Match || char2Match || char3Match || tagMatch;
                    });
                });
                
                debugLog(`Ë§áÊï∞„Ç≠„Éº„ÉØ„Éº„Éâ„Éï„Ç£„É´„Çø„ÉºÁµêÊûú: ${filtered.length}‰ª∂`, 'success');
            }

            // Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„ÉâÔºà„ÅÑ„Åö„Çå„Åã„ÅåÂê´„Åæ„Çå„Çã„ÇÇ„ÅÆ„ÇíÈô§Â§ñÔºâ
            if (excludeKeywords.size > 0) {
                const excludeTerms = Array.from(excludeKeywords).map(k => k.toLowerCase());
                debugLog(`Èô§Â§ñ„Ç≠„Éº„ÉØ„Éº„ÉâÂÆüË°å: [${excludeTerms.join(', ')}] - ÂØæË±°‰ª∂Êï∞: ${filtered.length}`, 'info');
                
                const beforeCount = filtered.length;
                filtered = filtered.filter(prompt => {
                    // „ÅÑ„Åö„Çå„Åã„ÅÆÈô§Â§ñ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà„ÅØÈô§Â§ñ
                    return !excludeTerms.some(excludeTerm => {
                        const titleMatch = prompt.title && prompt.title.toLowerCase().includes(excludeTerm);
                        const mainMatch = prompt.mainPrompt && prompt.mainPrompt.toLowerCase().includes(excludeTerm);
                        const char1Match = prompt.character1 && prompt.character1.toLowerCase().includes(excludeTerm);
                        const char2Match = prompt.character2 && prompt.character2.toLowerCase().includes(excludeTerm);
                        const char3Match = prompt.character3to6 && prompt.character3to6.toLowerCase().includes(excludeTerm);
                        const tagMatch = prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(excludeTerm));
                        
                        return titleMatch || mainMatch || char1Match || char2Match || char3Match || tagMatch;
                    });
                });
                
                debugLog(`Èô§Â§ñ„Éï„Ç£„É´„Çø„ÉºÁµêÊûú: ${filtered.length}‰ª∂ (${beforeCount - filtered.length}‰ª∂Èô§Â§ñ)`, 'success');
            }

            return filtered;
        }

        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂàá„ÇäË©∞„ÇÅ
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // „Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•ÂäõÊ¨Ñ„Å´Âæ©ÂÖÉ
        function restorePromptToInputs(id) {
            debugLog(`=== „Éó„É≠„É≥„Éó„ÉàÂæ©ÂÖÉÈñãÂßã ===`, 'info');
            debugLog(`ÂØæË±°ID: ${id}`, 'info');
            
            const prompt = prompts.find(p => p.id == id);
            if (!prompt) {
                debugLog(`„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ID=${id}`, 'error');
                return;
            }
            
            debugLog(`Ë¶ã„Å§„Åã„Å£„Åü„Éó„É≠„É≥„Éó„Éà: "${prompt.title}"`, 'success');
            
            // ÂêÑÂÖ•ÂäõÊ¨Ñ„Å´ÂÄ§„ÇíË®≠ÂÆö
            document.getElementById('promptTitle').value = prompt.title || '';
            document.getElementById('mainPrompt').value = prompt.mainPrompt || '';
            document.getElementById('character1').value = prompt.character1 || '';
            document.getElementById('character2').value = prompt.character2 || '';
            document.getElementById('character3to6').value = prompt.character3to6 || '';
            
            debugLog(`ÂÖ•ÂäõÊ¨Ñ„Å´ÂÄ§„ÇíË®≠ÂÆöÂÆå‰∫Ü`, 'success');
            
            // „Çø„Ç∞„ÇÇÂæ©ÂÖÉ
            currentTags.clear();
            if (prompt.tags) {
                prompt.tags.forEach(tag => currentTags.add(tag));
            }
            updateTagsDisplay();
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíË®≠ÂÆö
            currentEditingId = id;
            
            // „Éù„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰∏ÄÊôÇ‰øùÂ≠ò
            if (prompt.source === 'potion' || prompt.image) {
                window.currentPotionData = {
                    image: prompt.image,
                    imageName: prompt.imageName,
                    potionName: prompt.potionName
                };
            } else {
                window.currentPotionData = null;
            }
            
            // UIÊõ¥Êñ∞
            updatePotionPreview();
            updateSaveButtons();
            
            // „É°„Ç§„É≥„Éó„É≠„É≥„Éó„Éà„ÇíËá™Âãï„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
            if (prompt.mainPrompt) {
                try {
                    navigator.clipboard.writeText(prompt.mainPrompt).then(() => {
                        debugLog(`„É°„Ç§„É≥„Éó„É≠„É≥„Éó„Éà„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„ÉºÊàêÂäü`, 'success');
                    }).catch(err => {
                        debugLog(`„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Ç≥„Éî„Éº„Ç®„É©„Éº: ${err}`, 'warning');
                    });
                } catch (err) {
                    debugLog(`„ÇØ„É™„ÉÉ„Éó„Éú„Éº„ÉâAPI„Ç®„É©„Éº: ${err}`, 'warning');
                }
            }
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
            showNotification(`"${prompt.title || 'ÁÑ°È°å'}" „ÇíÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅßÂæ©ÂÖÉ„Åó„Åæ„Åó„ÅüÔºÅüìã„É°„Ç§„É≥„Éó„É≠„É≥„Éó„Éà„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº${prompt.source === 'potion' ? ' üß™' : ''}`);
            
            // ÂÖ•Âäõ„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            document.querySelector('.title-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÔºàË§áÊï∞ÂØæÂøúÔºâ
        function highlightSearchKeywords(content) {
            if (searchKeywords.size === 0 || !content) {
                return content || '';
            }

            let highlightedContent = content;
            
            // ÂêÑÊ§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„Éà
            Array.from(searchKeywords).forEach(keyword => {
                const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                highlightedContent = highlightedContent.replace(regex, '<span class="search-highlight">$1</span>');
            });
            
            return highlightedContent;
        }

        // „Éó„É≠„É≥„Éó„Éà„ÅÆÂâäÈô§
        function deletePrompt(id) {
            if (!confirm('„Åì„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            prompts = prompts.filter(p => p.id != id);
            
            // Firebase„ÅåÂà©Áî®ÂèØËÉΩ„Å™„ÇâFirebase„Å´‰øùÂ≠ò„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞localStorage
            if (firebaseReady && currentUser) {
                saveUserData();
            } else {
                savePrompts();
            }
            
            displayPrompts();
            updateStats();
            
            showNotification('„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }

        // Áµ±Ë®à„ÅÆÊõ¥Êñ∞
        function updateStats() {
            const total = prompts.length;
            const filtered = filterPrompts().length;
            const today = prompts.filter(p => {
                const promptDate = new Date(p.timestamp);
                const todayDate = new Date();
                return promptDate.toDateString() === todayDate.toDateString();
            }).length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('searchCount').textContent = filtered;
            document.getElementById('todayCount').textContent = today;
            document.getElementById('tagCount').textContent = allTags.size;
        }

        // „Éù„Éº„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø
        function loadPotions() {
            const potionInput = document.getElementById('potionInput');
            const files = potionInput.files;

            debugLog('=== „Éù„Éº„Ç∑„Éß„É≥Ë™≠„ÅøËæº„ÅøÈñãÂßã ===', 'info');
            debugLog('ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´Êï∞: ' + files.length, 'info');

            if (files.length === 0) {
                debugLog('„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                alert('„Éù„Éº„Ç∑„Éß„É≥„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            let loadedCount = 0;
            const totalFiles = files.length; // „Éï„Ç°„Ç§„É´Êï∞„Çí‰∫ãÂâç„Å´‰øùÂ≠ò
            const potionData = {};

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                debugLog('„Éï„Ç°„Ç§„É´Âá¶ÁêÜÈñãÂßã: ' + file.name + ' („Çø„Ç§„Éó: ' + fileExt + ')', 'info');
                
                if (['png', 'jpg', 'jpeg'].includes(fileExt)) {
                    // ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
                    debugLog('ÁîªÂÉè„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Ë™≠„ÅøËæº„Åø: ' + file.name, 'info');
                    reader.onload = function(e) {
                        const baseName = file.name.replace(/\.(png|jpg|jpeg)$/i, '');
                        if (!potionData[baseName]) {
                            potionData[baseName] = {};
                        }
                        potionData[baseName].image = e.target.result;
                        potionData[baseName].imageName = file.name;
                        
                        debugLog('ÁîªÂÉè„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ' + baseName, 'success');
                        debugLog('ÁîªÂÉè„Éá„Éº„Çø„Çµ„Ç§„Ç∫: ' + Math.round(e.target.result.length / 1024) + 'KB', 'info');
                        
                        loadedCount++;
                        debugLog('Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Ç´„Ç¶„É≥„Éà: ' + loadedCount + '/' + totalFiles, 'info');
                        if (loadedCount === totalFiles) {
                            debugLog('ÂÖ®„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÄÅprocessPotionDataÂëº„Å≥Âá∫„Åó', 'info');
                            processPotionData(potionData);
                        }
                    };
                    reader.readAsDataURL(file);
                } else if (['txt', 'json'].includes(fileExt)) {
                    // „ÉÜ„Ç≠„Çπ„Éà/JSON„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
                    debugLog('„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Ë™≠„ÅøËæº„Åø: ' + file.name, 'info');
                    reader.onload = function(e) {
                        const baseName = file.name.replace(/\.(txt|json)$/i, '');
                        if (!potionData[baseName]) {
                            potionData[baseName] = {};
                        }
                        
                        let content;
                        if (fileExt === 'json') {
                            try {
                                const jsonData = JSON.parse(e.target.result);
                                content = jsonData.prompt || jsonData.text || JSON.stringify(jsonData, null, 2);
                                debugLog('JSONËß£ÊûêÊàêÂäü: ' + baseName, 'success');
                            } catch (err) {
                                content = e.target.result;
                                debugLog('JSONËß£ÊûêÂ§±Êïó„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶Âá¶ÁêÜ: ' + baseName, 'warn');
                            }
                        } else {
                            content = e.target.result;
                        }
                        
                        potionData[baseName].content = content.trim();
                        potionData[baseName].textName = file.name;
                        
                        debugLog('„ÉÜ„Ç≠„Çπ„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ' + baseName, 'success');
                        debugLog('„ÉÜ„Ç≠„Çπ„ÉàÊñáÂ≠óÊï∞: ' + content.trim().length + 'ÊñáÂ≠ó', 'info');
                        
                        loadedCount++;
                        if (loadedCount === totalFiles) {
                            processPotionData(potionData);
                        }
                    };
                    reader.readAsText(file, 'UTF-8');
                } else {
                    debugLog('„Çµ„Éù„Éº„ÉàÂ§ñ„ÅÆ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè: ' + file.name, 'error');
                    alert(`${file.name} „ÅØ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô`);
                    loadedCount++;
                    if (loadedCount === totalFiles) {
                        processPotionData(potionData);
                    }
                }
            });

            potionInput.value = '';
        }

        // „Éù„Éº„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ
        function processPotionData(potionData) {
            debugLog('=== „Éù„Éº„Ç∑„Éß„É≥„Éá„Éº„ÇøÂá¶ÁêÜÈñãÂßã ===', 'info');
            debugLog('Âá¶ÁêÜÂØæË±°„Éù„Éº„Ç∑„Éß„É≥Êï∞: ' + Object.keys(potionData).length, 'info');
            
            let processedCount = 0;
            
            Object.keys(potionData).forEach(baseName => {
                const potion = potionData[baseName];
                debugLog('„Éù„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ‰∏≠: ' + baseName, 'info');
                debugLog('- „ÉÜ„Ç≠„Çπ„Éà: ' + (potion.content ? '„ÅÇ„Çä' : '„Å™„Åó'), 'info');
                debugLog('- ÁîªÂÉè: ' + (potion.image ? '„ÅÇ„Çä' : '„Å™„Åó'), 'info');
                
                // „ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Éó„É≠„É≥„Éó„Éà„Å®„Åó„Å¶‰øùÂ≠ò
                if (potion.content) {
                    const prompt = {
                        id: Date.now() + Math.random(),
                        title: baseName || (potion.content.substring(0, 30) + '...'),
                        mainPrompt: potion.content,
                        character1: '',
                        character2: '',
                        character3to6: '',
                        tags: ['„Éù„Éº„Ç∑„Éß„É≥'],
                        timestamp: new Date(),
                        source: 'potion',
                        potionName: baseName,
                        image: potion.image,
                        imageName: potion.imageName,
                        textName: potion.textName
                    };

                    prompts.unshift(prompt);
                    processedCount++;
                    debugLog('„Éù„Éº„Ç∑„Éß„É≥„Çí„Éó„É≠„É≥„Éó„Éà„Å®„Åó„Å¶ËøΩÂä†: ' + baseName, 'success');
                }
                
                // ÁîªÂÉè„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØÂÖ•ÂäõÊ¨Ñ„Å´„Éó„É¨„Éì„É•„ÉºË°®Á§∫
                if (potion.image && !potion.content) {
                    debugLog('ÁîªÂÉè„ÅÆ„Åø„ÅÆ„Éù„Éº„Ç∑„Éß„É≥Ê§úÂá∫: ' + baseName, 'info');
                    
                    // Êó¢Â≠ò„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const existingTitle = document.getElementById('promptTitle').value.trim();
                    const existingPrompt = document.getElementById('mainPrompt').value.trim();
                    
                    window.currentPotionData = {
                        image: potion.image,
                        imageName: potion.imageName,
                        potionName: baseName
                    };
                    debugLog('currentPotionDataË®≠ÂÆöÂÆå‰∫Ü', 'success');
                    debugLog('ÁîªÂÉè„Éá„Éº„ÇøÂÖàÈ†≠Á¢∫Ë™ç: ' + potion.image.substring(0, 30) + '...', 'info');
                    
                    // Êó¢Â≠ò„ÅÆÂÖ•Âäõ„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Çø„Ç§„Éà„É´„ÇíË®≠ÂÆö
                    if (!existingTitle) {
                        document.getElementById('promptTitle').value = baseName;
                        debugLog('„Çø„Ç§„Éà„É´„ÇíËá™ÂãïË®≠ÂÆö: ' + baseName, 'info');
                    } else {
                        debugLog('Êó¢Â≠ò„Çø„Ç§„Éà„É´„Çí‰øùÊåÅ: ' + existingTitle, 'info');
                    }
                    
                    updatePotionPreview();
                    debugLog('updatePotionPreviewÂëº„Å≥Âá∫„ÅóÂÆå‰∫Ü', 'success');
                }
            });
            
            debugLog('Âá¶ÁêÜÂÆå‰∫ÜÊï∞: ' + processedCount, 'info');
            
            if (processedCount > 0) {
                // „Éù„Éº„Ç∑„Éß„É≥„Çø„Ç∞„Çí„Ç∞„É≠„Éº„Éê„É´„Çø„Ç∞„Å´ËøΩÂä†
                allTags.add('„Éù„Éº„Ç∑„Éß„É≥');
                
                // ÊúÄÂàù„ÅÆ„Éù„Éº„Ç∑„Éß„É≥„ÇíÂÖ•ÂäõÊ¨Ñ„Å´Ëá™ÂãïË®≠ÂÆö„Åó„Å¶„Éó„É¨„Éì„É•„ÉºË°®Á§∫ÔºàÊó¢Â≠ò„ÅÆÂÖ•Âäõ„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (processedCount === 1) {
                    debugLog('Âçò‰∏Ä„Éù„Éº„Ç∑„Éß„É≥„ÇíÂÖ•ÂäõÊ¨Ñ„Å´Ëá™ÂãïË®≠ÂÆö', 'info');
                    const firstPotionName = Object.keys(potionData)[0];
                    const firstPotion = potionData[firstPotionName];
                    
                    // Êó¢Â≠ò„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const existingTitle = document.getElementById('promptTitle').value.trim();
                    const existingPrompt = document.getElementById('mainPrompt').value.trim();
                    
                    // Êó¢Â≠ò„ÅÆÂÖ•Âäõ„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøËá™ÂãïË®≠ÂÆö
                    if (!existingTitle && !existingPrompt) {
                        document.getElementById('promptTitle').value = firstPotionName;
                        document.getElementById('mainPrompt').value = firstPotion.content;
                        debugLog('ÂÖ•ÂäõÊ¨Ñ„ÅåÁ©∫„ÅÆ„Åü„ÇÅËá™ÂãïË®≠ÂÆö„ÇíÂÆüË°å', 'info');
                    } else {
                        debugLog('Êó¢Â≠ò„ÅÆÂÖ•Âäõ„Åå„ÅÇ„Çã„Åü„ÇÅËá™ÂãïË®≠ÂÆö„Çí„Çπ„Ç≠„ÉÉ„Éó', 'info');
                    }
                    
                    if (firstPotion.image) {
                        window.currentPotionData = {
                            image: firstPotion.image,
                            imageName: firstPotion.imageName,
                            potionName: firstPotionName
                        };
                        debugLog('Ëá™ÂãïË®≠ÂÆö„Åï„Çå„Åü„Éù„Éº„Ç∑„Éß„É≥: ' + firstPotionName, 'success');
                        updatePotionPreview();
                    }
                }
                
                savePrompts();
                displayPrompts();
                updateStats();
                updateTagsDisplay();
                showNotification(`${processedCount}ÂÄã„ÅÆ„Éù„Éº„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅüß™`);
                debugLog('„Éù„Éº„Ç∑„Éß„É≥Ë™≠„ÅøËæº„ÅøÊàêÂäü: ' + processedCount + 'ÂÄã', 'success');
            } else {
                showNotification('Ë™≠„ÅøËæº„ÅøÂèØËÉΩ„Å™„Éù„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                debugLog('Ë™≠„ÅøËæº„ÅøÂèØËÉΩ„Å™„Éù„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ', 'warn');
            }
            
            debugLog('=== „Éù„Éº„Ç∑„Éß„É≥„Éá„Éº„ÇøÂá¶ÁêÜÁµÇ‰∫Ü ===', 'info');
        }

        // „Éù„Éº„Ç∑„Éß„É≥„Éó„É¨„Éì„É•„Éº„ÅÆÊõ¥Êñ∞
        function updatePotionPreview() {
            const preview = document.getElementById('potionPreview');
            const previewImage = document.getElementById('potionPreviewImage');
            const previewName = document.getElementById('potionPreviewName');
            
            debugLog('=== updatePotionPreview ÈñãÂßã ===', 'info');
            debugLog('currentPotionData: ' + (window.currentPotionData ? '„ÅÇ„Çä' : '„Å™„Åó'), 'info');
            debugLog('previewË¶ÅÁ¥†: ' + (preview ? 'OK' : 'NG'), 'info');
            debugLog('previewImageË¶ÅÁ¥†: ' + (previewImage ? 'OK' : 'NG'), 'info');
            
            if (window.currentPotionData && window.currentPotionData.image) {
                const imageData = window.currentPotionData.image;
                debugLog('ÁîªÂÉè„Éá„Éº„Çø„ÅÇ„Çä', 'info');
                debugLog('ÁîªÂÉè„Éá„Éº„ÇøÂÖàÈ†≠: ' + imageData.substring(0, 50) + '...', 'info');
                debugLog('ÁîªÂÉè„Éá„Éº„Çø„Çø„Ç§„Éó: ' + (imageData.startsWith('data:') ? 'base64' : '„Åù„ÅÆ‰ªñ'), 'info');
                
                // Âº∑Âà∂ÁöÑ„Å´ÁîªÂÉè„ÇíË°®Á§∫
                previewImage.src = imageData;
                previewImage.style.display = 'block';
                previewImage.style.visibility = 'visible';
                previewImage.style.opacity = '1';
                
                previewName.textContent = window.currentPotionData.potionName || window.currentPotionData.imageName || '„Éù„Éº„Ç∑„Éß„É≥';
                preview.style.display = 'block';
                
                debugLog('ÁîªÂÉèsrcË®≠ÂÆöÂÆå‰∫Ü', 'success');
                
                // ÁîªÂÉèË™≠„ÅøËæº„ÅøÊàêÂäüÊôÇ
                previewImage.onload = function() {
                    debugLog('‚úÖ „Éù„Éº„Ç∑„Éß„É≥ÁîªÂÉèË™≠„ÅøËæº„ÅøÊàêÂäüÔºÅ „Çµ„Ç§„Ç∫: ' + this.naturalWidth + 'x' + this.naturalHeight, 'success');
                };
                
                // ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                previewImage.onerror = function() {
                    debugLog('‚ùå „Éù„Éº„Ç∑„Éß„É≥ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó', 'error');
                    debugLog('ÁîªÂÉè„Éá„Éº„Çø: ' + imageData.substring(0, 100) + '...', 'error');
                    previewName.textContent = 'ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº - ' + (window.currentPotionData.imageName || 'unknown');
                };
                
                // Âç≥Â∫ß„Å´Áä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                setTimeout(() => {
                    debugLog('1ÁßíÂæå„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ:', 'info');
                    debugLog('- complete: ' + previewImage.complete, 'info');
                    debugLog('- naturalWidth: ' + previewImage.naturalWidth, 'info');
                    debugLog('- display: ' + previewImage.style.display, 'info');
                }, 1000);
                
            } else {
                debugLog('‚ùå „Éù„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„Å™„Åó„ÄÅ„Éó„É¨„Éì„É•„ÉºÈùûË°®Á§∫', 'warn');
                preview.style.display = 'none';
            }
            
            debugLog('=== updatePotionPreview ÁµÇ‰∫Ü ===', 'info');
        }

        // ‰øùÂ≠ò„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
        function updateSaveButtons() {
            const overwriteBtn = document.getElementById('overwriteBtn');
            
            debugLog(`=== updateSaveButtonsÂÆüË°å ===`, 'info');
            debugLog(`currentEditingId: ${currentEditingId}`, 'info');
            
            if (currentEditingId) {
                overwriteBtn.style.display = 'block';
                debugLog('‰∏äÊõ∏„Åç„Éú„Çø„É≥„ÇíË°®Á§∫', 'success');
            } else {
                overwriteBtn.style.display = 'none';
                debugLog('‰∏äÊõ∏„Åç„Éú„Çø„É≥„ÇíÈùûË°®Á§∫', 'info');
            }
        }

        // „Éù„Éº„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅÆÂâäÈô§
        function removePotionData() {
            window.currentPotionData = null;
            updatePotionPreview();
            showNotification('„Éù„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }

        // localStorageÂÆåÂÖ®„É™„Çª„ÉÉ„Éà
        function resetLocalStorage() {
            if (confirm('üö® WARNING: ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇÊú¨ÂΩì„Å´ÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('novel_ai_prompts');
                prompts = [];
                allTags = new Set();
                debugLog('üî• localStorageÂÆåÂÖ®„ÇØ„É™„Ç¢ÂÆüË°å', 'info');
                displayPrompts();
                updateStats();
                updateTagsDisplay();
                showNotification('localStorageÂÆåÂÖ®„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
            }
        }

        // ÂÖ®ÂÖ•ÂäõÂÜÖÂÆπ„ÅÆ„ÇØ„É™„Ç¢
        function clearAllInputs() {
            clearInputs();
            updateTagsDisplay();
        }

        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞Èñ¢Êï∞
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            debugLogs.push(logEntry);
            
            // „É≠„Ç∞„ÅåÂ§ö„Åô„Åé„ÇãÂ†¥Âêà„ÅØÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
            if (debugLogs.length > 100) {
                debugLogs = debugLogs.slice(-50);
            }
            
            updateDebugDisplay();
        }

        // „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                debugLog('„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñã„Åç„Åæ„Åó„Åü', 'info');
                // „Éë„Éç„É´„ÇíÈñã„ÅÑ„ÅüÊôÇ„Å´Ëá™Âãï„Åß„É≠„Ç∞„Çí„Ç≥„Éî„Éº
                copyDebugLogs();
            } else {
                panel.style.display = 'none';
            }
        }

        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„ÅÆË°®Á§∫Êõ¥Êñ∞
        function updateDebugDisplay() {
            const logsContainer = document.getElementById('debugLogs');
            if (!logsContainer) return;
            
            logsContainer.innerHTML = debugLogs.map(log => 
                `<div class="debug-log-entry debug-log-${log.type}">
                    <strong>[${log.time}]</strong> ${log.message}
                </div>`
            ).join('');
            
            // ÊúÄÊñ∞„ÅÆ„É≠„Ç∞„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„ÅÆ„Ç≥„Éî„Éº
        async function copyDebugLogs() {
            if (debugLogs.length === 0) {
                debugLog('„Ç≥„Éî„Éº„Åô„Çã„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warn');
                return;
            }
            
            const logText = debugLogs.map(log => 
                `[${log.time}] ${log.type.toUpperCase()}: ${log.message}`
            ).join('\n');
            
            debugLog(`${debugLogs.length}‰ª∂„ÅÆ„É≠„Ç∞„Çí„Ç≥„Éî„Éº‰∏≠...`, 'info');
            
            try {
                await navigator.clipboard.writeText(logText);
                debugLog('‚úÖ „É≠„Ç∞„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                // ÈÄöÁü•„ÇÇË°®Á§∫
                showNotification('„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (err) {
                debugLog('‚ùå „É≠„Ç∞„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó: ' + err.message, 'error');
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: textarea‰ΩúÊàê„Åó„Å¶„Ç≥„Éî„Éº
                const textarea = document.createElement('textarea');
                textarea.value = logText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                debugLog('‰ª£ÊõøÊñπÊ≥ï„Åß„Ç≥„Éî„ÉºÂÆå‰∫Ü', 'success');
                showNotification('„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºà‰ª£ÊõøÊñπÊ≥ïÔºâ');
            }
        }

        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„ÅÆ„ÇØ„É™„Ç¢
        function clearDebugLogs() {
            debugLogs = [];
            updateDebugDisplay();
            debugLog('„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }

        // „Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            if (prompts.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const exportData = {
                prompts: prompts,
                tags: Array.from(allTags),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel_ai_prompts_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        // „Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.prompts && Array.isArray(importedData.prompts)) {
                            prompts = [...importedData.prompts, ...prompts];
                            
                            if (importedData.tags && Array.isArray(importedData.tags)) {
                                importedData.tags.forEach(tag => allTags.add(tag));
                            }
                            
                            savePrompts();
                            displayPrompts();
                            updateStats();
                            updateTagsDisplay();
                            showNotification(`${importedData.prompts.length}ÂÄã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ`);
                        } else {
                            alert('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
                        }
                    } catch (err) {
                        alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ÂÖ®„Éá„Éº„Çø„ÅÆÂâäÈô§
        function clearAll() {
            if (!confirm('ÂÖ®„Å¶„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;
            
            prompts = [];
            allTags.clear();
            currentTags.clear();
            savePrompts();
            displayPrompts();
            updateStats();
            updateTagsDisplay();
            showNotification('ÂÖ®„Å¶„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }

        // „Éá„Éº„Çø„ÅÆ‰øùÂ≠òÔºàlocalStorageÔºâ
        function savePrompts() {
            // ÁîªÂÉè„Éá„Éº„Çø„ÇÇÂê´„ÇÅ„Å¶localStorage„Å´‰øùÂ≠òÔºàIssue #001‰øÆÊ≠£Ôºâ
            const promptsForStorage = prompts;
            
            const saveData = {
                prompts: promptsForStorage,
                tags: Array.from(allTags)
            };
            
            debugLog(`üîß ÁîªÂÉèÈô§Â§ñÂæå„ÅÆ„Éó„É≠„É≥„Éó„ÉàÊ∫ñÂÇôÂÆå‰∫Ü`, 'info');
            debugLog(`localStorage‰øùÂ≠òÂÆüË°å: „Éó„É≠„É≥„Éó„Éà${prompts.length}‰ª∂„ÄÅ„Çø„Ç∞${allTags.size}ÂÄã`, 'info');
            try {
                const jsonString = JSON.stringify(saveData);
                debugLog(`JSONÊñáÂ≠óÂàóÈï∑: ${jsonString.length}ÊñáÂ≠ó (${(jsonString.length/1024/1024).toFixed(2)}MB)`, 'info');
                
                // localStorage„Çµ„Ç§„Ç∫Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
                try {
                    localStorage.setItem('test_size', jsonString);
                    localStorage.removeItem('test_size');
                    debugLog(`‚úÖ „Çµ„Ç§„Ç∫„ÉÜ„Çπ„ÉàÊàêÂäü: localStorageÂà∂ÈôêÂÜÖ`, 'success');
                } catch (sizeError) {
                    debugLog(`‚ùå „Çµ„Ç§„Ç∫„ÉÜ„Çπ„ÉàÂ§±Êïó: ${sizeError.message}`, 'error');
                    debugLog(`üö® CRITICAL: „Éá„Éº„Çø„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºÅÁîªÂÉè„Éá„Éº„Çø„ÇíÂâäÊ∏õ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`, 'error');
                    return;
                }
                
                localStorage.setItem('novel_ai_prompts', jsonString);
                
                // ‰øùÂ≠òÂæå„Å´Âç≥Â∫ß„Å´Ë™≠„ÅøËæº„Çì„ÅßÁ¢∫Ë™ç
                const verification = localStorage.getItem('novel_ai_prompts');
                if (verification) {
                    const verifyData = JSON.parse(verification);
                    debugLog(`‚úÖ ‰øùÂ≠òÁ¢∫Ë™ç: „Éó„É≠„É≥„Éó„Éà${verifyData.prompts.length}‰ª∂`, 'success');
                    
                    // ‰ªä‰øùÂ≠ò„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const latestPrompt = verifyData.prompts[0];
                    if (latestPrompt && latestPrompt.title === saveData.prompts[0].title) {
                        debugLog(`‚úÖ ÊúÄÊñ∞„Éó„É≠„É≥„Éó„ÉàÁ¢∫Ë™ç: "${latestPrompt.title}" ‰øùÂ≠òÊ∏à„Åø`, 'success');
                    } else {
                        debugLog(`‚ùå ÊúÄÊñ∞„Éó„É≠„É≥„Éó„ÉàÁ¢∫Ë™çÂ§±Êïó`, 'error');
                    }
                } else {
                    debugLog('‚ùå ‰øùÂ≠òÁ¢∫Ë™çÂ§±Êïó: „Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ', 'error');
                }
                
                debugLog('localStorage‰øùÂ≠òÊàêÂäü', 'success');
            } catch (err) {
                debugLog('localStorage‰øùÂ≠ò„Ç®„É©„Éº: ' + err.message, 'error');
                debugLog('„Ç®„É©„ÉºË©≥Á¥∞: ' + err.stack, 'error');
            }
        }

        // „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„ÅøÔºàlocalStorageÔºâ
        function loadPrompts() {
            debugLog('=== localStorageË™≠„ÅøËæº„ÅøÈñãÂßã ===', 'info');
            const saved = localStorage.getItem('novel_ai_prompts');
            if (saved) {
                debugLog('localStorage „Åã„Çâ„Éá„Éº„ÇøÁô∫Ë¶ã', 'info');
                try {
                    const data = JSON.parse(saved);
                    
                    if (data.prompts) {
                        prompts = data.prompts;
                        debugLog(`üîß „Éó„É≠„É≥„Éó„ÉàË™≠„ÅøËæº„Åø: ${prompts.length}‰ª∂ÔºàÁîªÂÉè„Éá„Éº„Çø„ÅØÈô§Â§ñÊ∏à„ÅøÔºâ`, 'success');
                        // Êó•ÊôÇ„ÅÆÊñáÂ≠óÂàó„ÇíDate„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ
                        prompts.forEach(prompt => {
                            if (typeof prompt.timestamp === 'string') {
                                prompt.timestamp = new Date(prompt.timestamp);
                            }
                            // Âè§„ÅÑ„Éá„Éº„ÇøÊßãÈÄ†„Å®„ÅÆ‰∫íÊèõÊÄß
                            if (!prompt.character1) {
                                prompt.character1 = '';
                                prompt.character2 = '';
                                prompt.character3to6 = '';
                                prompt.mainPrompt = prompt.content || '';
                            }
                            if (!prompt.tags) {
                                prompt.tags = [];
                            }
                            // „Çø„Ç§„Éà„É´„Éï„Ç£„Éº„É´„Éâ„ÅÆËøΩÂä†ÔºàV0.21‰ª•ÈôçÔºâ
                            if (!prompt.title) {
                                prompt.title = prompt.mainPrompt ? 
                                    truncateText(prompt.mainPrompt, 30) : 'ÁÑ°È°å';
                            }
                        });
                    }
                    
                    if (data.tags) {
                        allTags = new Set(data.tags);
                    }
                } catch (err) {
                    console.error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
                    debugLog('localStorageË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + err.message, 'error');
                    prompts = [];
                    allTags = new Set();
                }
            } else {
                debugLog('localStorage „Å´„Éá„Éº„Çø„Å™„ÅóÔºàÂàùÂõûËµ∑ÂãïÔºâ', 'info');
            }
            debugLog('=== localStorageË™≠„ÅøËæº„ÅøÁµÇ‰∫Ü ===', 'info');
        }

        // Êó•ÊôÇ„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDateTime(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const minute = String(d.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hour}:${minute}`;
        }

        // ÈÄöÁü•„ÅÆË°®Á§∫
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®CSSÔºàÂãïÁöÑ„Å´ËøΩÂä†Ôºâ
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // ========== „É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÊ©üËÉΩ ==========
        
        // „É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        function switchMode(mode) {
            debugLog(`=== „É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÈñãÂßã: ${currentMode} ‚Üí ${mode} ===`, 'info');
            
            if (currentMode === mode) {
                debugLog('Âêå„Åò„É¢„Éº„Éâ„ÅÆ„Åü„ÇÅÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó', 'warning');
                return;
            }
            
            // ÁèæÂú®„ÅÆ„É¢„Éº„Éâ„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò
            savePromptsForMode();
            
            // Êñ∞„Åó„ÅÑ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
            currentMode = mode;
            
            // „Çø„Éñ„ÅÆË°®Á§∫Êõ¥Êñ∞
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Êñ∞„Åó„ÅÑ„É¢„Éº„Éâ„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            loadPromptsForMode(mode);
            
            debugLog(`„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÂÆå‰∫Ü: ${mode}`, 'success');
            showNotification(`${mode === 'novelai' ? 'üé® Novel AI' : 'üíª Claude Code'}„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„ÅüÔºÅ`);
        }
        
        // „É¢„Éº„ÉâÂà•„Éá„Éº„Çø‰øùÂ≠ò
        function savePromptsForMode() {
            const storageKey = `promptManager_${currentMode}_prompts`;
            const tagsKey = `promptManager_${currentMode}_tags`;
            
            debugLog(`${currentMode}„É¢„Éº„Éâ„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò: ${prompts.length}‰ª∂`, 'info');
            localStorage.setItem(storageKey, JSON.stringify(prompts));
            localStorage.setItem(tagsKey, JSON.stringify(Array.from(allTags)));
        }
        
        // „É¢„Éº„ÉâÂà•„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        function loadPromptsForMode(mode) {
            const storageKey = `promptManager_${mode}_prompts`;
            const tagsKey = `promptManager_${mode}_tags`;
            
            try {
                const stored = localStorage.getItem(storageKey);
                prompts = stored ? JSON.parse(stored) : [];
                
                const storedTags = localStorage.getItem(tagsKey);
                allTags = new Set(storedTags ? JSON.parse(storedTags) : []);
                
                debugLog(`${mode}„É¢„Éº„Éâ„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø: ${prompts.length}‰ª∂`, 'info');
                
                // UIÊõ¥Êñ∞
                displayPrompts();
                updateStats();
                updateTagsDisplay();
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
                clearInputs();
                
            } catch (error) {
                debugLog(`${mode}„É¢„Éº„Éâ„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`, 'error');
                prompts = [];
                allTags = new Set();
                displayPrompts();
                updateStats();
                updateTagsDisplay();
            }
        }
    </script>
</body>
</html>